{"version":3,"sources":["webpack:///./components/app.js"],"names":["xin","require","App","title","document","__appSignature","location","window","history","handlers","middlewares","__started","addEventListener","evt","console","error","detail","hashSeparator","reHashSeparator","RegExp","start","pattern","match","str","chunks","split","length","Error","tokens","re","replace","g","token","push","optRe","slice","route","callback","routeHandler","type","args","__isStatic","result","__routeRegExp","__starting","async","__tryStart","check","then","executors","mode","checkAndExecute","bind","defaultPrevented","target","nodeName","preventDefault","pushState","url","getAttribute","innerHTML","href","info","__getId","fire","fragment","Promise","resolve","reject","getFragment","running","forEach","handler","name","index","err","executers","promise","middleware","apply","executer","uri","catch","stack","path","options","rootUri","toString","origin","decodeURI","pathname","search","back","String","value","observer","Component","define","module","exports"],"mappings":"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","file":"components/app.js","sourcesContent":["const xin = require('../index');\n\nclass App extends xin.Component {\n  get props () {\n    return {\n      title: {\n        type: String,\n        value: 'Application',\n        observer: '_titleChanged',\n      },\n\n      mode: {\n        type: String,\n        value: 'hash',\n      },\n\n      rootUri: {\n        type: String,\n        value: '/',\n      },\n\n      hashSeparator: {\n        type: String,\n        value: '#!',\n        observer: '_hashSeparatorChanged',\n      },\n    };\n  }\n\n  _titleChanged (title) {\n    document.title = title;\n  }\n\n  created () {\n    this.__appSignature = true;\n    this.location = window.location;\n    this.history = window.history;\n\n    // default values\n    this.handlers = [];\n    this.middlewares = [];\n\n    this.__started = false;\n\n    this.addEventListener('route-not-found', function (evt) {\n      console.error('Route not found: ' + evt.detail);\n    });\n\n    // var originalNotify = this.__notify;\n    // this.__notify = function (path, value, oldValue) {\n    //   originalNotify.apply(this, arguments);\n    //   if (path[0] === '$') {\n    //     this.fire('property-sync', {\n    //       property: path,\n    //       value: value,\n    //       oldValue: oldValue,\n    //     });\n    //   }\n    // };\n  }\n\n  _hashSeparatorChanged (hashSeparator) {\n    this.reHashSeparator = new RegExp(hashSeparator + '(.*)$');\n  }\n\n  attached () {\n    this.start();\n  }\n\n  __isStatic (pattern) {\n    return !pattern.match(/[[{]/);\n  }\n\n  __routeRegExp (str) {\n    var chunks = str.split('[');\n\n    if (chunks.length > 2) {\n      throw new Error('Invalid use of optional params');\n    }\n\n    var tokens = [];\n    var re = chunks[0].replace(/{([^}]+)}/g, function (g, token) {\n      tokens.push(token);\n      return '([^/]+)';\n    }).replace(/\\//g, '\\\\/');\n\n    var optRe = '';\n\n    if (chunks[1]) {\n      optRe = '(?:' + chunks[1].slice(0, -1).replace(/{([^}]+)}/g, function (g, token) {\n        tokens.push(token);\n        return '([^/]+)';\n      }).replace(/\\//g, '\\\\/') + ')?';\n    }\n    return [new RegExp('^' + re + optRe + '$'), tokens];\n  }\n\n  route (route, callback) {\n    var routeHandler = {\n      route: route,\n      type: 's',\n      pattern: null,\n      args: [],\n      callback: callback,\n    };\n\n    if (!this.__isStatic(route)) {\n      routeHandler.type = 'v';\n      var result = this.__routeRegExp(route);\n      routeHandler.pattern = result[0];\n      routeHandler.args = result[1];\n    }\n\n    this.handlers.push(routeHandler);\n\n    // when app already on starting state but not accomplished yet will try start when one handler pushed\n    if (this.__starting) {\n      this.__starting = false;\n      this.async(this.__tryStart);\n    }\n  }\n\n  start () {\n    this.__starting = true;\n    this.check().then(executors => {\n      if (executors.length > 0) {\n        this.__starting = false;\n        this.__tryStart();\n      }\n    });\n  }\n\n  __tryStart () {\n    if (this.mode === 'history') {\n      window.addEventListener('popstate', this.checkAndExecute.bind(this), false);\n      document.addEventListener('click', function (evt) {\n        if (!evt.defaultPrevented && evt.target.nodeName === 'A' && evt.target.target === '') {\n          evt.preventDefault();\n          this.history.pushState({\n            url: evt.target.getAttribute('href'),\n          }, evt.target.innerHTML, evt.target.href);\n          this.checkAndExecute();\n        }\n      }.bind(this));\n    } else {\n      window.addEventListener('hashchange', this.checkAndExecute.bind(this), false);\n    }\n\n    this.checkAndExecute()\n      .then(function () {\n        console.info('Started    ' + this.__getId());\n        this.fire('started');\n        this.__started = true;\n      }.bind(this));\n  }\n\n  isStarted () {\n    return this.__started || false;\n  }\n\n  check (fragment) {\n    return new Promise(function (resolve, reject) {\n      try {\n        fragment = fragment || this.getFragment();\n        var running = [];\n        this.handlers.forEach(function (handler) {\n          if (handler.type === 's') {\n            if (fragment === handler.route) {\n              running.push({\n                handler: handler,\n                args: {},\n              });\n              return;\n            }\n          } else if (handler.type === 'v') {\n            // matches is unused\n            // var matches = [];\n            var result = fragment.match(handler.pattern);\n            // if (result) {\n            //   matches = result.slice(1);\n            // }\n\n            if (result) {\n              var args = {};\n\n              handler.args.forEach(function (name, index) {\n                args[name] = result[index + 1];\n              });\n\n              running.push({\n                handler: handler,\n                args: args,\n              });\n            }\n          }\n        });\n\n        resolve(running);\n      } catch (err) {\n        reject(err);\n      }\n    }.bind(this));\n  }\n\n  checkAndExecute () {\n    var fragment = this.getFragment();\n\n    return this.check(fragment)\n      .then(function (executers) {\n        if (executers.length) {\n          var promise = Promise.resolve();\n          this.middlewares.forEach(function (middleware) {\n            promise = promise.then(function () {\n              return middleware.apply(this);\n            }.bind(this));\n          }.bind(this));\n\n          return promise.then(function () {\n            executers.forEach(function (executer) {\n              executer.handler.callback(executer.args);\n            });\n\n            this.fire('navigated', {uri: fragment});\n            return executers;\n          }.bind(this));\n        }\n\n        this.fire('route-not-found', fragment);\n        return [];\n      }.bind(this))\n      .catch(function (err) {\n        console.error('Uncaught checkAndExecute error, ' + err.stack);\n      });\n  }\n\n  navigate (path, options) {\n    path = path || '/';\n    options = options || {};\n\n    if (this.mode === 'history') {\n      var url = this.rootUri + path.toString().replace(/\\/$/, '').replace(/^\\//, '');\n      if (this.location.href.replace(this.location.origin, '') !== url) {\n        this.history[options.replace ? 'replaceState' : 'pushState']({}, document.title, url);\n        this.checkAndExecute();\n      }\n    } else {\n      this.location.href.match(this.reHashSeparator);\n      this.location.href = this.location.href.replace(this.reHashSeparator, '') + this.hashSeparator + path;\n    }\n    return this;\n  }\n\n  use (middleware) {\n    this.middlewares.push(middleware);\n  }\n\n  // REMOVED, you can use getFragment()\n  // getURI () {\n  //   if (this.mode === 'hash') {\n  //     return this.location.hash.replace(this.hashSeparator, '') || '/';\n  //   } else {\n  //     throw new Error('Unimplemented getURI from history mode');\n  //   }\n  // },\n\n  getFragment () {\n    var fragment;\n    if (this.mode === 'history') {\n      fragment = decodeURI(this.location.pathname + this.location.search);\n      fragment = fragment.replace(/\\?(.*)$/, '');\n      fragment = this.rootUri === '/' ? fragment : fragment.replace(this.rootUri, '');\n    } else {\n      var match = this.location.href.match(this.reHashSeparator);\n      fragment = match ? match[1] : '';\n    }\n\n    return '/' + fragment.toString().replace(/\\/$/, '').replace(/^\\//, '');\n  }\n\n  $back (evt) {\n    evt.preventDefault();\n    this.history.back();\n  }\n}\n\nxin.define('xin-app', App);\n\nxin.App = App;\n\nmodule.exports = App;\n\n\n\n/** WEBPACK FOOTER **\n ** ./components/app.js\n **/"],"sourceRoot":""}